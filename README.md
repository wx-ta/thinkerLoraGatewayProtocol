## 简介
网关通过MQTT协议同后台服务通信，数据上报topic为epower-gateway-data-reporting-topic,载荷为json字符串，MQTT链路采用单向证书认证机制通信。

## XX医院新协议

粤北医院新采集协议，采用网关解析节点上报的二进制数据，转换成json后上报后台，json上报后台的协议字段直接对应具体的值类型和取值。

### 一、抄表数据数据上报
抄表数据上传是Lora网关主动上报给后台服务的报文，MQTT topic为epower-gateway-data-reporting-topic，载荷为json字符串。

示例报文：
```
{
	"version": 2,
	"gatewayId": "GW312B09D4",
	"type": "report",
	"subType": "polldata",
	"timeStamp": 1562830009,
	"nodeId": "ND10010138",
	"nodeType": 1,
	"payload": {
		"version":1,
		"timeStamp": 1562830009,
		"channels":
		[
			{
				"ch":0,
				"values":
				[
					{
						"valueType": 1,
						"value":"230.4"
					},
					{
						"valueType": 13,
						"value":"89645.21"
					}
				]
			},
			{
				"ch":1,
				"values":
				[
					{
						"valueType": 1,
						"value":"212.2"
					},
					{
						"valueType": 13,
						"value":"89645.21"
					}
				]
			}
		]
	}
}
```

#### 字段说明

字段 | 说明   
-|-
version | 整形数字，表示数据载荷部分协议版本号，目前版本为2  |
gatewayId | 表示网关唯一id，是以GW开头，后跟4个两位16进制字符的字符串（范围00-FF大写）  |
type |  表示数据帧类型，可取值“report”，表示这是一条节点报告的帧类型，此帧中用作节点报告能耗数据。 可取值“gatewayReport”，表示这个数据帧是网关的自身的产生的帧类型，比如UPS状态发生变化等的状态通知 |
subType | 表示数据帧的子类型。可取值“alarm”这是一条网关轮询来的数据。可取值“pollData”,表示这是一条能耗数据上报帧。可取值“upsStatus”，表示这是一条通知ups状态的帧。可取值“heartbeat”，表示这是一条心跳帧 |
timeStamp | Lora网关上传此数据帧的标准时间戳 |
nodeId | 表示节点唯一id，是以ND开头，后跟4个两位16进制字符的字符串（范围00-FF大写） |
nodeType | 表示节点类型，整型，取值范围0-255，类型定义见下面表格 |
payload | 表示帧的载荷数据类型是json object，内部字段说明，见下面表格 |

#### nodeType 类型定义

字段 | 说明   
-|-
0 | 混合节点，表示此节点的所接入的表具类型可以是混合的，比如0-6通道上接了电表，7-8通道上接了水表  |
1 | 电表节点 |
2 | 冷水表节点 |
3 | 热水表节点 |
4 | 天然气表节点 |
5 | 氧气表节点 |
... | ... |

#### payload object协议字段说明

字段 | 说明   
-|-
version | 类型为整形数字，表示网关发送给后台服务通信帧的协议版本号，目前版本为1  |
timeStamp | Lora节点采集此数据时的标准时间戳 |
channels | 类型为json数组，包含该节点所有通道的测量值，数组大小至多255，表示该节点最多可以接入255个表具， channels下面的字段说明，见下面表格 |

#### channels array元素字段说明

字段 | 说明   
-|-
ch | 类型为整型数字，表示该数据的通道号，举例说明，老电表节点是一个采集节点采集一个电表，是一对一结构，所以对应的ch值为0；现在粤北热水表采用一个节点采集8路热水表，故通道号为0-7  |
values | 类型为json数组，包含了该通道下的测量值类型和对应的测量值，values里面有多少的元素就代表这个通道上的仪表有多少个测量值，举例说明，电表测量值有电压、电流，电量三个值，那么values下面就会有三个数组元素，数组元素字段说明见下面表格 |

#### values array元素字段说明

字段 | 说明   
-|-
valuesType | 类型为整型数字，表示该测量值的类型，取值范围0-255，涵盖了所有电表、水表、气表、冷热量表的测量值类型，此映射表采用定义的映射关系，下节有定义表  |
value | 类型为字符串，表示测量值，为了兼容性，采用字符串类型，字符串表示的具体意义可能是整型形数字或浮点数字，比如电量消耗5986.6度，此字段将会是"value":"5986.6"|

#### values type映射表

测量值代号和测量值的映射关系，总共256个测量值类型，现定义如下映射关系。

为了方便之后功能扩展，各个大类的表记类型都有预留，电表相关的测量值预留代号1-40，水表相关的测量值预留代号41-45，气表相关测量值预留代号46-50，能量表相关测量值预留51-55

value type | 测量值 | 单位 | 取值范围
-|-|-|-
0 | 预留 | ... | ...
1 |  A相电压  | V | 0-99999.99
2 |  A相电流  | A | 0-99999.99
3 |  A相功率  | Kw| 0-999999.99
4 |  A相功率因数 | 无 | 0.000-1.000
5 |  B相电压  | V | 0-99999.99
6 |  B相电流  | A | 0-99999.99
7 |  B相功率  | Kw| 0-999999.99
8 |  B相功率因数  | 无 | 0.000-1.000
9 |  C相电压  | V | 0-99999.99
10 |  C相电流  | A | 0-99999.99
11 | C相功率  | Kw | 0-999999.99
12 | C相功率因数  | 无 | 0.000-1.000
13 | 有功电能   | Kw/h | 0-999999999.99
14 | 无功电能   | Kw/h | 0-999999999.99
15 | A相电压3次谐波 | % | 0.00-99.99 
16 | B相电压3次谐波 | % | 0.00-99.99  
17 | C相电压3次谐波  | % | 0.00-99.99 
18 | A相电流3次谐波  | % | 0.00-99.99 
19 | B相电流3次谐波  | % | 0.00-99.99 
20 | C相电流3次谐波  | % | 0.00-99.99 
21 | A相电压5次谐波  | % | 0.00-99.99 
22 | B相电压5次谐波  | % | 0.00-99.99 
23 | C相电压5次谐波  | % | 0.00-99.99 
24 | A相电流5次谐波  | % | 0.00-99.99 
25 | B相电流5次谐波  | % | 0.00-99.99 
26 | C相电流5次谐波  | % | 0.00-99.99 
27 | A相电压7次谐波  | % | 0.00-99.99 
28 | B相电压7次谐波  | % | 0.00-99.99 
29 | C相电压7次谐波  | % | 0.00-99.99 
30 | A相电流7次谐波  | % | 0.00-99.99  
31 | B相电流7次谐波  | % | 0.00-99.99 
32 | C相电流7次谐波  | % | 0.00-99.99 
->40 | 电表测量值扩展| ... | ... 
41 | 冷水用水量 | 立方米 | 0-999999999.99
42 | 热水用水量 | 立方米 | 0-999999999.99
43 | 水压	| KPa | 0-999999.99
->45 | 水表相关测量值扩展| ... | ... 
46 | 天然气用气量 | 立方米 | 0-999999999.99
47 | 气压		| KPa | 0-999999.99
->50 | 气表相关测量值扩展| ... | ... 
51 | 冷量表 | Kw/h | 0-999999999.99
->55 | 热量相关测量值扩展| ... | ... 
56 | 氧气用气量 | 立方米 | 0-999999999.99|   


---   
综上，开头所示的通信帧和含义为：有一个编号为GW312B09D4的网关轮询得到一条来自ND10010138采集节点的能耗数据，该节点采集了2个通道，也就是接了两个表，每个表输出了两个数据类型，按照《values type映射表》可以查到，他们分别是A相电压和有功功率，通道0上的测量值分别是230.4v和89645.21kw/h。


### 二、心跳数据上报
心跳数据上传是Lora网关主动上报给后台服务的报文，MQTT topic为epower-gateway-heartbeat-topic，载荷为json字符串，为方便解析，json首层数据结构与抄表数据上报协议保持一致。

示例报文：
```
{
	"version": 2,
	"gatewayId": "GW312B09D4",
	"type": "gatewayReport",
	"subType": "heartbeat",
	"timeStamp": 1562830009,
	"nodeId": null,
	"nodeType": null,
	"payload": null
}
```
### 心跳帧字段说明

字段 | 说明   
-|-
version | 整形数字，表示数据载荷部分协议版本号，目前版本为2  |
gatewayId | 表示网关唯一id，是以GW开头，后跟4个两位16进制字符的字符串（范围00-FF大写）  |
type |  表示数据帧类型取值“gatewayReport”，表示这个数据帧是网关的自身的产生的帧类型 |
subType | 表示数据帧的子类型。取值“heartbeat”，表示这是一条心跳帧 |
timeStamp | Lora网关上传此数据帧的标准时间戳 |
nodeId | 表示节点唯一id，取值空 |
nodeType | 表示节点类型，取值空 |
payload | 表示帧的载荷数据类型是json object，取值空 |



### 三、节点状态变化上报
节点状态变化上报是Lora网关发现下辖的节点在线状态发生变化后，主动上报给后台服务的报文，MQTT topic为epower-gateway-notify-topic，载荷为json字符串，为方便解析，json首层数据结构与抄表数据上报协议保持一致。

示例报文：
```
{
	"version": 2,
	"gatewayId": "GW312B09D4",
	"type": "gatewayReport",
	"subType": "nodeStatusNotify",
	"timeStamp": 1562830009,
	"nodeId": "ND10010138",
	"nodeType": 1,
	"payload": {
		"version":1,
		"status":"online"
	}
}
```
### 节点状态变化帧字段说明

字段 | 说明   
-|-
version | 整形数字，表示数据载荷部分协议版本号，目前版本为2  |
gatewayId | 表示网关唯一id，是以GW开头，后跟4个两位16进制字符的字符串（范围00-FF大写）  |
type |  表示数据帧类型取值“gatewayReport”，表示这个数据帧是网关的自身的产生的帧类型 |
subType | 表示数据帧的子类型。取值“nodeStatusNotify”，表示这是一条设备状态变化通知帧 |
timeStamp | Lora网关上传此数据帧的标准时间戳 |
nodeId | 表示节点唯一id，是以ND开头，后跟4个两位16进制字符的字符串（范围00-FF大写） |
nodeType | 表示节点类型，整型，取值范围0-255，类型定义见下面表格 |
payload | 表示帧的载荷数据类型是json object，内部字段说明，见下面表格 |

### payload json object字段说明
字段 | 说明   
-|-
version | 类型为整形数字，表示网关发送给后台服务通信帧的协议版本号，目前版本为1  |
status | 类型为json字符串，可取值"online"表示节点在线，可取值"offline"表示节点不在线 |


### 四、后台服务主动获取Lora网关下辖离线节点列表

此操作分为“后台请求”和“网关回复”两个基本通信过程。
当Lora网关收到来自后台的报告离线网关列表请求后，通过MQTT发送自己下辖的离线网关列表
后台请求MQTT topic为“epower-server-requst-topic-”+gatewayId
topic示例，后台发送给gatewayId为GW312B09D4的Lora网关的MQTT topic应为“epower-server-requst-topic-GW312B09D4”
使用网关id作为topic的好处是，后台发送的请求信息会单播给指定的网关，而不是所有网关使用同一个topic导致广播给所有的网关造成资源浪费。
报文示例：
```
{
	"version": 2,
	"gatewayId": "GW312B09D4",
	"type": "serverRequest",
	"subType": "offlineListRequest",
	"TimeStamp": 1562830009,
	"nodeId": null,
	"nodeType": null,
	"payload": null
}
```

### 后台请求帧字段说明

字段 | 说明   
-|-
version | 整形数字，表示数据载荷部分协议版本号，目前版本为2  |
gatewayId | 表示请求网关唯一id，是以GW开头，后跟4个两位16进制字符的字符串（范围00-FF大写）  |
type |  表示数据帧类型取值“serverRequest”，表示这个数据帧是后台发送给网关的请求帧类型 |
subType | 表示数据帧的子类型。取值“offlineListRequest”，表示请求离线列表 |
timeStamp | 后台请求的标准时间戳 |
nodeId | 表示节点唯一id，取值空 |
nodeType | 表示节点类型，取值空 |


网关收到后台的请求后，会通过MQTT上报后台离线节点列表，MQTT topic为epower-gateway-response-topic，载荷为json字符串，为方便解析，json首层数据结构与抄表数据上报协议保持一致。

示例报文：
```
{
	"version": 2,
	"gatewayId": "GW312B09D4",
	"type": "gatewayResponse",
	"subType": "offlineListResponse",
	"timeStamp": 1562830009,
	"nodeId": null,
	"nodeType": null,
	"payload": {
		"version":1,
		"offlineList":[
    		"GW312B09D4",
    		"GW312B09D5"
		]
	}
}
```
### 帧字段说明

字段 | 说明   
-|-
version | 整形数字，表示数据载荷部分协议版本号，目前版本为2  |
gatewayId | 表示网关唯一id，是以GW开头，后跟4个两位16进制字符的字符串（范围00-FF大写）  |
type |  表示数据帧类型取值“gatewayResponse”，表示这个数据帧是网关请求的回复帧 |
subType | 表示数据帧的子类型。取值“offlineListResponse”，表示这是一条离线节点列表回复帧 |
timeStamp | Lora网关上传此数据帧的标准时间戳 |
nodeId | 表示节点唯一id，取值空 |
nodeType | 表示节点类型，取值空 |
payload | 表示帧的载荷数据类型是json object，内部字段说明，见下面表格 |

### payload json object字段说明
字段 | 说明   
-|-
version | 类型为整形数字，表示网关发送给后台服务通信帧的协议版本号，目前版本为1  |
offlineList | 类型为json数组，数组元素类型为json字符串，内容是节点的id,有多少个节点离线，offlineList就有多少个元素，如果没有离线节点，offlineList = [] |






---



